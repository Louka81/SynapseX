#include "./SysHook.hpp"
#include "../../Exploit/Misc/Static.hpp"

#include "./AntiDump.hpp"

#include <DbgHelp.h>

namespace syn::AntiDump
{
    bool Setup()
    {
        DWORD Target = (DWORD)syn::FindModule(OBFUSCATE_STR("shell32.dll"));

        PIMAGE_NT_HEADERS NTHeader = ImageNtHeader(syn::Module);
        PIMAGE_SECTION_HEADER SectionHeader = (PIMAGE_SECTION_HEADER)(NTHeader + 1);

        uint32_t FakeSections = (NTHeader->OptionalHeader.SizeOfHeaders - ((DWORD)SectionHeader - (uint32_t)syn::Module)) / sizeof(IMAGE_SECTION_HEADER) - 1;

        DWORD Old;
        SafeVirtualProtect(NTHeader, 0x400, PAGE_READWRITE, &Old);

        for (uint32_t i = 0; i < FakeSections; i++)
        {
            SectionHeader[i] = {};
            auto& section = SectionHeader[i];

            section.Name[0] = 'g';
            section.Name[1] = 'a';
            section.Name[2] = 'm';
            section.Name[3] = 'e';
            section.Name[4] = 'r';
        }

        return true;
    }
}
