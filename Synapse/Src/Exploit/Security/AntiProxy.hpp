#pragma once

#include "../Misc/Static.hpp"
#include <winhttp.h>

namespace syn::AntiProxy
{
	__forceinline bool Check()
	{
		WINHTTP_CURRENT_USER_IE_PROXY_CONFIG ProxySettings;
		SecureZeroMemory(&ProxySettings, sizeof(WINHTTP_CURRENT_USER_IE_PROXY_CONFIG));

		if (WinHttpGetIEProxyConfigForCurrentUser(&ProxySettings))
		{
			if (ProxySettings.lpszProxy)
			{
				const std::wstring ProxyUrl(ProxySettings.lpszProxy);

				if (ProxyUrl.find(L"127.0.0.1") != std::string::npos || ProxyUrl.find(L":8888") != std::string::npos)
					return true;

				GlobalFree(ProxySettings.lpszProxy);
			}

			/* "The caller must free the lpszProxy, lpszProxyBypass and lpszAutoConfigUrl strings in the 
			 * WINHTTP_CURRENT_USER_IE_PROXY_CONFIG structure if they are non-NULL. Use GlobalFree to free 
		     * the strings." */
			if (ProxySettings.lpszProxyBypass)
				GlobalFree(ProxySettings.lpszProxyBypass);

			if (ProxySettings.lpszAutoConfigUrl)
				GlobalFree(ProxySettings.lpszAutoConfigUrl);
		}

		return false;
	}
}